name: CI - Build & Test
on:
  push:
    branches: [main, dev]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'pom.xml'
      - 'plugin.yml'
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'
        
    - run: mvn -B clean package
      
    - uses: actions/upload-artifact@v4
      with:
        name: plugin-jar
        path: target/*.jar

  test:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 3
    
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: plugin-jar
        
    - run: |
        mkdir test-server
        cd test-server
        
        wget -q https://fill-data.papermc.io/v1/objects/158703f75a26f842ea656b3dc6d75bf3d1ec176b97a2c36384d0b80b3871af53/paper-1.21.10-130.jar -O server.jar
        
        echo "eula=true" > eula.txt
        
        mkdir plugins
        cp ../*.jar plugins/
        
    - run: |
        cd test-server
        
        timeout 120 java -Xmx1G -Xms1G -jar server.jar --nogui &
        SERVER_PID=$!
        
        sleep 60
        
        if grep -q "Done" logs/latest.log; then
          echo "Server started"
          
          if grep -q "HyticInv" logs/latest.log && grep -q "enabled" logs/latest.log; then
            echo "Plugin loaded successfully"
          else
            echo "Plugin failed to load"
            cat logs/latest.log
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi
        else
          echo "Server failed to start"
          cat logs/latest.log
          kill $SERVER_PID 2>/dev/null
          exit 1
        fi
        
        kill $SERVER_PID
        wait $SERVER_PID 2>/dev/null
        
    - name: Cleanup
      if: always()
      run: rm -rf test-server
